function QiniuJsSDK(){var e;e="https:"===window.location.protocol?"https://up.qbox.me":"http://upload.qiniu.com",this.detectIEVersion=function(){for(var e=4,t=document.createElement("div"),n=t.getElementsByTagName("i");t.innerHTML="<!--[if gt IE "+e+"]><i></i><![endif]-->",n[0];)e++;return e>4?e:!1},this.isImage=function(e){var t,n="",r=["png","jpg","jpeg","gif","bmp"],i=/\.([a-zA-Z0-9]+)(\?|\@|$)/;if(!e||!i.test(e))return!1;t=i.exec(e),n=t[1].toLowerCase();for(var s=0,o=r.length;o>s;s++)if(n===r[s])return!0;return!1},this.getFileExtension=function(e){var t,n=e.split(".");return t=1===n.length||""===n[0]&&2===n.length?"":n.pop().toLowerCase()},this.utf8_encode=function(e){if(null===e||"undefined"==typeof e)return"";var t,n,r=e+"",i="",s=0;t=n=0,s=r.length;for(var o=0;s>o;o++){var u=r.charCodeAt(o),a=null;if(128>u)n++;else if(u>127&&2048>u)a=String.fromCharCode(u>>6|192,63&u|128);else if(63488&u^!0)a=String.fromCharCode(u>>12|224,u>>6&63|128,63&u|128);else{if(64512&u^!0)throw new RangeError("Unmatched trail surrogate at "+o);var f=r.charCodeAt(++o);if(64512&f^!0)throw new RangeError("Unmatched lead surrogate at "+(o-1));u=((1023&u)<<10)+(1023&f)+65536,a=String.fromCharCode(u>>18|240,u>>12&63|128,u>>6&63|128,63&u|128)}null!==a&&(n>t&&(i+=r.slice(t,n)),i+=a,t=n=o+1)}return n>t&&(i+=r.slice(t,s)),i},this.base64_encode=function(e){var t,n,r,i,s,o,u,a,f="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",l=0,c=0,h="",p=[];if(!e)return e;e=this.utf8_encode(e+"");do t=e.charCodeAt(l++),n=e.charCodeAt(l++),r=e.charCodeAt(l++),a=t<<16|n<<8|r,i=a>>18&63,s=a>>12&63,o=a>>6&63,u=63&a,p[c++]=f.charAt(i)+f.charAt(s)+f.charAt(o)+f.charAt(u);while(l<e.length);switch(h=p.join(""),e.length%3){case 1:h=h.slice(0,-2)+"==";break;case 2:h=h.slice(0,-1)+"="}return h},this.URLSafeBase64Encode=function(e){return e=this.base64_encode(e),e.replace(/\//g,"_").replace(/\+/g,"-")},this.createAjax=function(e){var t={};return t=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP")},this.parseJSON=function(e){return window.JSON&&window.JSON.parse?window.JSON.parse(e):null===e?e:"string"==typeof e&&(e=this.trim(e),e&&/^[\],:{}\s]*$/.test(e.replace(/\\(?:["\\\/bfnrt]|u[\da-fA-F]{4})/g,"@").replace(/"[^"\\\r\n]*"|true|false|null|-?(?:\d+\.|)\d+(?:[eE][+-]?\d+|)/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))?function(){return e}():void 0},this.trim=function(e){return null===e?"":e.replace(/^\s+|\s+$/g,"")};var t=this;this.uploader=function(n){if(!n.domain)throw"uptoken_url or domain is required!";if(!n.browse_button)throw"browse_button is required!";var r={},i=n.init&&n.init.Error,s=n.init&&n.init.FileUploaded;n.init.Error=function(){},n.init.FileUploaded=function(){},t.uptoken_url=n.uptoken_url,t.token="",t.key_handler="function"==typeof n.init.Key?n.init.Key:"",this.domain=n.domain;var o="",u={isResumeUpload:!1,resumeFilesize:0,startTime:"",currentTime:""},f=function(){var e,r,i,s=t.detectIEVersion(),o="Safari"===mOxie.Env.browser&&mOxie.Env.version<=5&&"Windows"===mOxie.Env.os&&"7"===mOxie.Env.osVersion||"Safari"===mOxie.Env.browser&&"iOS"===mOxie.Env.os&&"7"===mOxie.Env.osVersion;s&&9>=s&&n.chunk_size&&n.runtimes.indexOf("flash")>=0?n.chunk_size=0:o?n.chunk_size=0:(e=20,r=4<<e,i=plupload.parseSize(n.chunk_size),i>r&&(n.chunk_size=r))};f();var l=function(){if(n.uptoken)t.token=n.uptoken;else{var e=t.createAjax();e.open("GET",t.uptoken_url,!0),e.setRequestHeader("If-Modified-Since","0"),e.onreadystatechange=function(){if(4===e.readyState&&200===e.status){var n=t.parseJSON(e.responseText);t.token=n.uptoken}},e.send()}},c=function(e,r,i){var s="",o=!1;if(!n.save_key)if(o=e.getOption&&e.getOption("unique_names"),o=o||e.settings&&e.settings.unique_names){var u=t.getFileExtension(r.name);s=u?r.id+"."+u:r.id}else s="function"==typeof i?i(e,r):r.name;return s};plupload.extend(r,n,{url:e,multipart_params:{token:""}});var h=new plupload.Uploader(r);return h.bind("Init",function(e,t){l()}),h.init(),h.bind("FilesAdded",function(e,t){var n=e.getOption&&e.getOption("auto_start");n=n||e.settings&&e.settings.auto_start,n&&plupload.each(t,function(t,n){e.start()}),e.refresh()}),h.bind("BeforeUpload",function(r,i){i.speed=i.speed||0,o="",n.get_new_uptoken&&l();var s=function(r,i,s){u.startTime=(new Date).getTime();var o;o=n.save_key?{token:t.token}:{key:c(r,i,s),token:t.token};var f=n.x_vars;if(void 0!==f&&"object"==typeof f)for(var l in f)f.hasOwnProperty(l)&&("function"==typeof f[l]?o["x:"+l]=f[l](r,i):"object"!=typeof f[l]&&(o["x:"+l]=f[l]));r.setOption({url:e,multipart:!0,chunk_size:void 0,multipart_params:o})},f=r.getOption&&r.getOption("chunk_size");if(f=f||r.settings&&r.settings.chunk_size,"html5"===h.runtime&&f)if(i.size<f)s(r,i,t.key_handler);else{var p=localStorage.getItem(i.name),d=f;if(p){p=JSON.parse(p);var v=(new Date).getTime(),m=p.time||0,y=864e5;y>v-m&&100!==p.percent&&i.size===p.total?(i.percent=p.percent,i.loaded=p.offset,o=p.ctx,u.isResumeUpload=!0,u.resumeFilesize=p.offset,p.offset+d>i.size&&(d=i.size-p.offset)):localStorage.removeItem(i.name)}u.startTime=(new Date).getTime(),r.setOption({url:e+"/mkblk/"+d,multipart:!1,chunk_size:f,required_features:"chunks",headers:{Authorization:"UpToken "+t.token},multipart_params:{}})}else s(r,i,t.key_handler)}),h.bind("UploadProgress",function(e,t){u.currentTime=(new Date).getTime();var n=u.currentTime-u.startTime,r=t.loaded||0;u.isResumeUpload&&(r=t.loaded-u.resumeFilesize),t.speed=(r/n*1e3).toFixed(0)||0}),h.bind("ChunkUploaded",function(n,r,i){var s=t.parseJSON(i.response);o=o?o+","+s.ctx:s.ctx;var u=i.total-i.offset,f=n.getOption&&n.getOption("chunk_size");f=f||n.settings&&n.settings.chunk_size,f>u&&n.setOption({url:e+"/mkblk/"+u}),localStorage.setItem(r.name,JSON.stringify({ctx:o,percent:r.percent,total:i.total,offset:i.offset,time:(new Date).getTime()}))}),h.bind("Error",function(e){return function(n,r){var i="",s=r.file;if(s){switch(r.code){case plupload.FAILED:i="上传失败。请稍后再试。";break;case plupload.FILE_SIZE_ERROR:var o=n.getOption&&n.getOption("max_file_size");o=o||n.settings&&n.settings.max_file_size,i="浏览器最大可上传"+o+"。更大文件请使用命令行工具。";break;case plupload.FILE_EXTENSION_ERROR:i="文件验证失败。请稍后重试。";break;case plupload.HTTP_ERROR:if(""===r.response){i=r.message||"未知网络错误。";break}var u=t.parseJSON(r.response),f=u.error;switch(r.status){case 400:i="请求报文格式错误。";break;case 401:i="客户端认证授权失败。请重试或提交反馈。";break;case 405:i="客户端请求错误。请重试或提交反馈。";break;case 579:i="资源上传成功，但回调失败。";break;case 599:i="网络连接异常。请重试或提交反馈。";break;case 614:i="文件已存在。";try{u=t.parseJSON(u.error),f=u.error||"file exists"}catch(l){f=u.error||"file exists"}break;case 631:i="指定空间不存在。";break;case 701:i="上传数据块校验出错。请重试或提交反馈。";break;default:i="未知错误。"}i=i+"("+r.status+"："+f+")";break;case plupload.SECURITY_ERROR:i="安全配置错误。请联系网站管理员。";break;case plupload.GENERIC_ERROR:i="上传失败。请稍后再试。";break;case plupload.IO_ERROR:i="上传失败。请稍后再试。";break;case plupload.INIT_ERROR:i="网站配置错误。请联系网站管理员。",h.destroy();break;default:i=r.message+r.details}e&&e(n,r,i)}n.refresh()}}(i)),h.bind("FileUploaded",function(r){return function(i,s,u){var f=function(e,i,s){if(n.downtoken_url){var o=t.createAjax();o.open("POST",n.downtoken_url,!0),o.setRequestHeader("Content-type","application/x-www-form-urlencoded"),o.onreadystatechange=function(){if(4===o.readyState)if(200===o.status){var n;try{n=t.parseJSON(o.responseText)}catch(u){throw"invalid json format"}var f={};plupload.extend(f,t.parseJSON(s),n),r&&r(e,i,JSON.stringify(f))}else h.trigger("Error",{status:o.status,response:o.responseText,file:i,code:plupload.HTTP_ERROR})},o.send("key="+t.parseJSON(s).key+"&domain="+n.domain)}else r&&r(e,i,s)},l=t.parseJSON(u.response);if(o=o?o:l.ctx){var p="";n.save_key||(p=c(i,s,t.key_handler),p=p?"/key/"+t.URLSafeBase64Encode(p):"");var v="/fname/"+t.URLSafeBase64Encode(s.name),m=n.x_vars,y="",w="";if(void 0!==m&&"object"==typeof m)for(var E in m)m.hasOwnProperty(E)&&("function"==typeof m[E]?y=t.URLSafeBase64Encode(m[E](i,s)):"object"!=typeof m[E]&&(y=t.URLSafeBase64Encode(m[E])),w+="/x:"+E+"/"+y);var S=e+"/mkfile/"+s.size+p+v+w,x=t.createAjax();x.open("POST",S,!0),x.setRequestHeader("Content-Type","text/plain;charset=UTF-8"),x.setRequestHeader("Authorization","UpToken "+t.token),x.onreadystatechange=function(){if(4===x.readyState)if(localStorage.removeItem(s.name),200===x.status){var e=x.responseText;f(i,s,e)}else h.trigger("Error",{status:x.status,response:x.responseText,file:s,code:-200})},x.send(o)}else f(i,s,u.response)}}(s)),h},this.getUrl=function(e){if(!e)return!1;e=encodeURI(e);var t=this.domain;return"/"!==t.slice(t.length-1)&&(t+="/"),t+e},this.imageView2=function(e,t){var n=e.mode||"",r=e.w||"",i=e.h||"",s=e.q||"",o=e.format||"";if(!n)return!1;if(!r&&!i)return!1;var u="imageView2/"+n;return u+=r?"/w/"+r:"",u+=i?"/h/"+i:"",u+=s?"/q/"+s:"",u+=o?"/format/"+o:"",t&&(u=this.getUrl(t)+"?"+u),u},this.imageMogr2=function(e,t){var n=e["auto-orient"]||"",r=e.thumbnail||"",i=e.strip||"",s=e.gravity||"",o=e.crop||"",u=e.quality||"",a=e.rotate||"",f=e.format||"",l=e.blur||"",c="imageMogr2";return c+=n?"/auto-orient":"",c+=r?"/thumbnail/"+r:"",c+=i?"/strip":"",c+=s?"/gravity/"+s:"",c+=u?"/quality/"+u:"",c+=o?"/crop/"+o:"",c+=a?"/rotate/"+a:"",c+=f?"/format/"+f:"",c+=l?"/blur/"+l:"",t&&(c=this.getUrl(t)+"?"+c),c},this.watermark=function(e,t){var n=e.mode;if(!n)return!1;var r="watermark/"+n;if(1===n){var i=e.image||"";if(!i)return!1;r+=i?"/image/"+this.URLSafeBase64Encode(i):""}else{if(2!==n)return!1;var s=e.text?e.text:"",o=e.font?e.font:"",u=e.fontsize?e.fontsize:"",a=e.fill?e.fill:"";if(!s)return!1;r+=s?"/text/"+this.URLSafeBase64Encode(s):"",r+=o?"/font/"+this.URLSafeBase64Encode(o):"",r+=u?"/fontsize/"+u:"",r+=a?"/fill/"+this.URLSafeBase64Encode(a):""}var f=e.dissolve||"",l=e.gravity||"",c=e.dx||"",h=e.dy||"";return r+=f?"/dissolve/"+f:"",r+=l?"/gravity/"+l:"",r+=c?"/dx/"+c:"",r+=h?"/dy/"+h:"",t&&(r=this.getUrl(t)+"?"+r),r},this.imageInfo=function(e){if(!e)return!1;var t,n=this.getUrl(e)+"?imageInfo",r=this.createAjax(),i=this;return r.open("GET",n,!1),r.onreadystatechange=function(){4===r.readyState&&200===r.status&&(t=i.parseJSON(r.responseText))},r.send(),t},this.exif=function(e){if(!e)return!1;var t,n=this.getUrl(e)+"?exif",r=this.createAjax(),i=this;return r.open("GET",n,!1),r.onreadystatechange=function(){4===r.readyState&&200===r.status&&(t=i.parseJSON(r.responseText))},r.send(),t},this.get=function(e,t){return t&&e?"exif"===e?this.exif(t):"imageInfo"===e?this.imageInfo(t):!1:!1},this.pipeline=function(e,t){var n,r,i="[object Array]"===Object.prototype.toString.call(e),s="";if(i){for(var o=0,u=e.length;u>o;o++){if(n=e[o],!n.fop)return!1;switch(n.fop){case"watermark":s+=this.watermark(n)+"|";break;case"imageView2":s+=this.imageView2(n)+"|";break;case"imageMogr2":s+=this.imageMogr2(n)+"|";break;default:r=!0}if(r)return!1}if(t){s=this.getUrl(t)+"?"+s;var a=s.length;"|"===s.slice(a-1)&&(s=s.slice(0,a-1))}return s}return!1}}var Qiniu=new QiniuJsSDK;