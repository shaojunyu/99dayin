function QiniuJsSDK(){var e;window.location.protocol==="https:"?e="https://up.qbox.me":e="http://upload.qiniu.com",this.detectIEVersion=function(){var e=4,t=document.createElement("div"),n=t.getElementsByTagName("i");while(t.innerHTML="<!--[if gt IE "+e+"]><i></i><![endif]-->",n[0])e++;return e>4?e:!1},this.isImage=function(e){var t,n="",r=["png","jpg","jpeg","gif","bmp"],i=/\.([a-zA-Z0-9]+)(\?|\@|$)/;if(!e||!i.test(e))return!1;t=i.exec(e),n=t[1].toLowerCase();for(var s=0,o=r.length;s<o;s++)if(n===r[s])return!0;return!1},this.getFileExtension=function(e){var t=e.split("."),n;return t.length===1||t[0]===""&&t.length===2?n="":n=t.pop().toLowerCase(),n},this.utf8_encode=function(e){if(e===null||typeof e=="undefined")return"";var t=e+"",n="",r,i,s=0;r=i=0,s=t.length;for(var o=0;o<s;o++){var u=t.charCodeAt(o),a=null;if(u<128)i++;else if(u>127&&u<2048)a=String.fromCharCode(u>>6|192,u&63|128);else if(u&63488^!0)a=String.fromCharCode(u>>12|224,u>>6&63|128,u&63|128);else{if(u&64512^!0)throw new RangeError("Unmatched trail surrogate at "+o);var f=t.charCodeAt(++o);if(f&64512^!0)throw new RangeError("Unmatched lead surrogate at "+(o-1));u=((u&1023)<<10)+(f&1023)+65536,a=String.fromCharCode(u>>18|240,u>>12&63|128,u>>6&63|128,u&63|128)}a!==null&&(i>r&&(n+=t.slice(r,i)),n+=a,r=i=o+1)}return i>r&&(n+=t.slice(r,s)),n},this.base64_encode=function(e){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",n,r,i,s,o,u,a,f,l=0,c=0,h="",p=[];if(!e)return e;e=this.utf8_encode(e+"");do n=e.charCodeAt(l++),r=e.charCodeAt(l++),i=e.charCodeAt(l++),f=n<<16|r<<8|i,s=f>>18&63,o=f>>12&63,u=f>>6&63,a=f&63,p[c++]=t.charAt(s)+t.charAt(o)+t.charAt(u)+t.charAt(a);while(l<e.length);h=p.join("");switch(e.length%3){case 1:h=h.slice(0,-2)+"==";break;case 2:h=h.slice(0,-1)+"="}return h},this.URLSafeBase64Encode=function(e){return e=this.base64_encode(e),e.replace(/\//g,"_").replace(/\+/g,"-")},this.createAjax=function(e){var t={};return window.XMLHttpRequest?t=new XMLHttpRequest:t=new ActiveXObject("Microsoft.XMLHTTP"),t},this.parseJSON=function(e){if(window.JSON&&window.JSON.parse)return window.JSON.parse(e);if(e===null)return e;if(typeof e=="string"){e=this.trim(e);if(e&&/^[\],:{}\s]*$/.test(e.replace(/\\(?:["\\\/bfnrt]|u[\da-fA-F]{4})/g,"@").replace(/"[^"\\\r\n]*"|true|false|null|-?(?:\d+\.|)\d+(?:[eE][+-]?\d+|)/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return function(){return e}()}},this.trim=function(e){return e===null?"":e.replace(/^\s+|\s+$/g,"")};var t=this;this.uploader=function(n){if(!n.domain)throw"uptoken_url or domain is required!";if(!n.browse_button)throw"browse_button is required!";var r={},i=n.init&&n.init.Error,s=n.init&&n.init.FileUploaded;n.init.Error=function(){},n.init.FileUploaded=function(){},t.uptoken_url=n.uptoken_url,t.token="",t.key_handler=typeof n.init.Key=="function"?n.init.Key:"",this.domain=n.domain;var o="",u={isResumeUpload:!1,resumeFilesize:0,startTime:"",currentTime:""},a=function(){var e=t.detectIEVersion(),r,i,s,o=mOxie.Env.browser==="Safari"&&mOxie.Env.version<=5&&mOxie.Env.os==="Windows"&&mOxie.Env.osVersion==="7"||mOxie.Env.browser==="Safari"&&mOxie.Env.os==="iOS"&&mOxie.Env.osVersion==="7";e&&e<=9&&n.chunk_size&&n.runtimes.indexOf("flash")>=0?n.chunk_size=0:o?n.chunk_size=0:(r=20,i=4<<r,s=plupload.parseSize(n.chunk_size),s>i&&(n.chunk_size=i))};a();var f=function(){if(!n.uptoken){var e=t.createAjax();e.open("GET",t.uptoken_url,!0),e.setRequestHeader("If-Modified-Since","0"),e.onreadystatechange=function(){if(e.readyState===4&&e.status===200){var n=t.parseJSON(e.responseText);t.token=n.uptoken}},e.send()}else t.token=n.uptoken},l=function(e,r,i){var s="",o=!1;if(!n.save_key){o=e.getOption&&e.getOption("unique_names"),o=o||e.settings&&e.settings.unique_names;if(o){var u=t.getFileExtension(r.name);s=u?r.id+"."+u:r.id}else typeof i=="function"?s=i(e,r):s=r.name}return s};plupload.extend(r,n,{url:e,multipart_params:{token:""}});var c=new plupload.Uploader(r);return c.bind("Init",function(e,t){f()}),c.init(),c.bind("FilesAdded",function(e,t){var n=e.getOption&&e.getOption("auto_start");n=n||e.settings&&e.settings.auto_start,n&&plupload.each(t,function(t,n){e.start()}),e.refresh()}),c.bind("BeforeUpload",function(r,i){i.speed=i.speed||0,o="",n.get_new_uptoken&&f();var s=function(r,i,s){u.startTime=(new Date).getTime();var o;n.save_key?o={token:t.token}:o={key:l(r,i,s),token:t.token};var a=n.x_vars;if(a!==undefined&&typeof a=="object")for(var f in a)a.hasOwnProperty(f)&&(typeof a[f]=="function"?o["x:"+f]=a[f](r,i):typeof a[f]!="object"&&(o["x:"+f]=a[f]));r.setOption({url:e,multipart:!0,chunk_size:undefined,multipart_params:o})},a=r.getOption&&r.getOption("chunk_size");a=a||r.settings&&r.settings.chunk_size;if(c.runtime==="html5"&&a)if(i.size<a)s(r,i,t.key_handler);else{var h=localStorage.getItem(i.name),p=a;if(h){h=JSON.parse(h);var d=(new Date).getTime(),v=h.time||0,m=864e5;d-v<m?h.percent!==100?i.size===h.total?(i.percent=h.percent,i.loaded=h.offset,o=h.ctx,u.isResumeUpload=!0,u.resumeFilesize=h.offset,h.offset+p>i.size&&(p=i.size-h.offset)):localStorage.removeItem(i.name):localStorage.removeItem(i.name):localStorage.removeItem(i.name)}u.startTime=(new Date).getTime(),r.setOption({url:e+"/mkblk/"+p,multipart:!1,chunk_size:a,required_features:"chunks",headers:{Authorization:"UpToken "+t.token},multipart_params:{}})}else s(r,i,t.key_handler)}),c.bind("UploadProgress",function(e,t){u.currentTime=(new Date).getTime();var n=u.currentTime-u.startTime,r=t.loaded||0;u.isResumeUpload&&(r=t.loaded-u.resumeFilesize),t.speed=(r/n*1e3).toFixed(0)||0}),c.bind("ChunkUploaded",function(n,r,i){var s=t.parseJSON(i.response);o=o?o+","+s.ctx:s.ctx;var u=i.total-i.offset,a=n.getOption&&n.getOption("chunk_size");a=a||n.settings&&n.settings.chunk_size,u<a&&n.setOption({url:e+"/mkblk/"+u}),localStorage.setItem(r.name,JSON.stringify({ctx:o,percent:r.percent,total:i.total,offset:i.offset,time:(new Date).getTime()}))}),c.bind("Error",function(e){return function(n,r){var i="",s=r.file;if(s){switch(r.code){case plupload.FAILED:i="上传失败。请稍后再试。";break;case plupload.FILE_SIZE_ERROR:var o=n.getOption&&n.getOption("max_file_size");o=o||n.settings&&n.settings.max_file_size,i="浏览器最大可上传"+o+"。更大文件请使用命令行工具。";break;case plupload.FILE_EXTENSION_ERROR:i="文件验证失败。请稍后重试。";break;case plupload.HTTP_ERROR:if(r.response===""){i=r.message||"未知网络错误。";break}var u=t.parseJSON(r.response),a=u.error;switch(r.status){case 400:i="请求报文格式错误。";break;case 401:i="客户端认证授权失败。请重试或提交反馈。";break;case 405:i="客户端请求错误。请重试或提交反馈。";break;case 579:i="资源上传成功，但回调失败。";break;case 599:i="网络连接异常。请重试或提交反馈。";break;case 614:i="文件已存在。";try{u=t.parseJSON(u.error),a=u.error||"file exists"}catch(f){a=u.error||"file exists"}break;case 631:i="指定空间不存在。";break;case 701:i="上传数据块校验出错。请重试或提交反馈。";break;default:i="未知错误。"}i=i+"("+r.status+"："+a+")";break;case plupload.SECURITY_ERROR:i="安全配置错误。请联系网站管理员。";break;case plupload.GENERIC_ERROR:i="上传失败。请稍后再试。";break;case plupload.IO_ERROR:i="上传失败。请稍后再试。";break;case plupload.INIT_ERROR:i="网站配置错误。请联系网站管理员。",c.destroy();break;default:i=r.message+r.details}e&&e(n,r,i)}n.refresh()}}(i)),c.bind("FileUploaded",function(r){return function(i,s,u){var a=function(e,i,s){if(n.downtoken_url){var o=t.createAjax();o.open("POST",n.downtoken_url,!0),o.setRequestHeader("Content-type","application/x-www-form-urlencoded"),o.onreadystatechange=function(){if(o.readyState===4)if(o.status===200){var n;try{n=t.parseJSON(o.responseText)}catch(u){throw"invalid json format"}var a={};plupload.extend(a,t.parseJSON(s),n),r&&r(e,i,JSON.stringify(a))}else c.trigger("Error",{status:o.status,response:o.responseText,file:i,code:plupload.HTTP_ERROR})},o.send("key="+t.parseJSON(s).key+"&domain="+n.domain)}else r&&r(e,i,s)},f=t.parseJSON(u.response);o=o?o:f.ctx;if(o){var h="";n.save_key||(h=l(i,s,t.key_handler),h=h?"/key/"+t.URLSafeBase64Encode(h):"");var p="/fname/"+t.URLSafeBase64Encode(s.name),d=n.x_vars,v="",m="";if(d!==undefined&&typeof d=="object")for(var g in d)d.hasOwnProperty(g)&&(typeof d[g]=="function"?v=t.URLSafeBase64Encode(d[g](i,s)):typeof d[g]!="object"&&(v=t.URLSafeBase64Encode(d[g])),m+="/x:"+g+"/"+v);var y=e+"/mkfile/"+s.size+h+p+m,b=t.createAjax();b.open("POST",y,!0),b.setRequestHeader("Content-Type","text/plain;charset=UTF-8"),b.setRequestHeader("Authorization","UpToken "+t.token),b.onreadystatechange=function(){if(b.readyState===4){localStorage.removeItem(s.name);if(b.status===200){var e=b.responseText;a(i,s,e)}else c.trigger("Error",{status:b.status,response:b.responseText,file:s,code:-200})}},b.send(o)}else a(i,s,u.response)}}(s)),c},this.getUrl=function(e){if(!e)return!1;e=encodeURI(e);var t=this.domain;return t.slice(t.length-1)!=="/"&&(t+="/"),t+e},this.imageView2=function(e,t){var n=e.mode||"",r=e.w||"",i=e.h||"",s=e.q||"",o=e.format||"";if(!n)return!1;if(!r&&!i)return!1;var u="imageView2/"+n;return u+=r?"/w/"+r:"",u+=i?"/h/"+i:"",u+=s?"/q/"+s:"",u+=o?"/format/"+o:"",t&&(u=this.getUrl(t)+"?"+u),u},this.imageMogr2=function(e,t){var n=e["auto-orient"]||"",r=e.thumbnail||"",i=e.strip||"",s=e.gravity||"",o=e.crop||"",u=e.quality||"",a=e.rotate||"",f=e.format||"",l=e.blur||"",c="imageMogr2";return c+=n?"/auto-orient":"",c+=r?"/thumbnail/"+r:"",c+=i?"/strip":"",c+=s?"/gravity/"+s:"",c+=u?"/quality/"+u:"",c+=o?"/crop/"+o:"",c+=a?"/rotate/"+a:"",c+=f?"/format/"+f:"",c+=l?"/blur/"+l:"",t&&(c=this.getUrl(t)+"?"+c),c},this.watermark=function(e,t){var n=e.mode;if(!n)return!1;var r="watermark/"+n;if(n===1){var i=e.image||"";if(!i)return!1;r+=i?"/image/"+this.URLSafeBase64Encode(i):""}else{if(n!==2)return!1;var s=e.text?e.text:"",o=e.font?e.font:"",u=e.fontsize?e.fontsize:"",a=e.fill?e.fill:"";if(!s)return!1;r+=s?"/text/"+this.URLSafeBase64Encode(s):"",r+=o?"/font/"+this.URLSafeBase64Encode(o):"",r+=u?"/fontsize/"+u:"",r+=a?"/fill/"+this.URLSafeBase64Encode(a):""}var f=e.dissolve||"",l=e.gravity||"",c=e.dx||"",h=e.dy||"";return r+=f?"/dissolve/"+f:"",r+=l?"/gravity/"+l:"",r+=c?"/dx/"+c:"",r+=h?"/dy/"+h:"",t&&(r=this.getUrl(t)+"?"+r),r},this.imageInfo=function(e){if(!e)return!1;var t=this.getUrl(e)+"?imageInfo",n=this.createAjax(),r,i=this;return n.open("GET",t,!1),n.onreadystatechange=function(){n.readyState===4&&n.status===200&&(r=i.parseJSON(n.responseText))},n.send(),r},this.exif=function(e){if(!e)return!1;var t=this.getUrl(e)+"?exif",n=this.createAjax(),r,i=this;return n.open("GET",t,!1),n.onreadystatechange=function(){n.readyState===4&&n.status===200&&(r=i.parseJSON(n.responseText))},n.send(),r},this.get=function(e,t){return!t||!e?!1:e==="exif"?this.exif(t):e==="imageInfo"?this.imageInfo(t):!1},this.pipeline=function(e,t){var n=Object.prototype.toString.call(e)==="[object Array]",r,i,s="";if(n){for(var o=0,u=e.length;o<u;o++){r=e[o];if(!r.fop)return!1;switch(r.fop){case"watermark":s+=this.watermark(r)+"|";break;case"imageView2":s+=this.imageView2(r)+"|";break;case"imageMogr2":s+=this.imageMogr2(r)+"|";break;default:i=!0}if(i)return!1}if(t){s=this.getUrl(t)+"?"+s;var a=s.length;s.slice(a-1)==="|"&&(s=s.slice(0,a-1))}return s}return!1}}var Qiniu=new QiniuJsSDK;