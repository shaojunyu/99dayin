var upload={upload:$("#file-upload"),format:/\.(txt|doc|ppt|docx|wps|rtf|pdf|xls)$/,content_a:$(".container-upload"),maxLength:20,shopping:$(".files-content"),addBtn:$(".article-content"),delete_btn:$("#scroller"),aliToken:{},expire:0,filesArray:new Array,official:new Array,init:function(){this.init2(),this.addBtn.on("click",function(e){var t=$(e.target);if(t.hasClass("add-btn")){var n=t.attr("data-area"),r=t.attr("data-mark"),i=t.parents(".article-item"),s=document.createElement("li");Base.alreadyAdd(t),_this.official.push({area:n,mark:r}),s.innerHTML=i.html().replace("already-add","logo-error"),_this.shopping.append(s),refresh()}}),this.delete_btn.on("click",function(e){var t=$(e.target);t.hasClass("logo-error")&&_this.deleteItem(t)})},getAjax:function(){var t="";return console.log("ajax"),$.ajax({url:Pathurl.getToken,type:"get",contentType:"application/json",dataType:"json"}).done(function(e){t=e}).fail(function(){alert("网络错误,请重新发送~"),window.location.href="./"}),t},init2:function(){var t=this,n=new plupload.Uploader({runtimes:"html5,flash,silverlight,html4",browse_button:"container-upload",container:document.getElementById("file-content"),url:"http://oss.aliyuncs.com",filters:{mime_types:[{title:"document",extensions:"txt,doc,ppt,docx,wps,rtf,pdf,xls"}],max_file_size:"50mb",prevent_duplicates:!0},init:{PostInit:function(){console.log("this is a num"),console.info($("#file-upload")),t.$upload.on("change",function(){return console.log("change"),t.setPara(n),n.start(),!1})},UploadProgress:function(t,n){prompt.changeInfo(n.percent+"%")},FileUploaded:function(n,r,s){console.log(s.status),t.setPara(n);if(s.status==200){var o=new Date,u=o.getFullYear()+"/"+(o.getMonth()+1)+"/"+o.getDate(),a=Number(files[i].size/1048576).toFixed(2)+"MB";addFiles(r,u,a,r.id),t.changeInputText(1),prompt.changeInfo("上传成功~")}else prompt.changeInfo("上传失败!")},Error:function(n,r){t.setPara(n),console.log("网络错误~")}}});n.init()},setPara:function(t){var n=this.getAjax();console.log("setPara"),new_multipart_params={key:n.key+"${filename}",policy:n.policyBase64,OSSAccessKeyId:n.accessid,success_action_status:"200",callback:n.callbackbody,signature:n.signature},t.setOption({url:n.host,multipart_params:new_multipart_params})},changeInputText:function(t){var n=Number(this.content_a.attr("data-num"));this.content_a.attr("data-num",n+t)},addFiles:function(t,n,r,i){var s=t.name.toLowerCase(),o=s.indexOf("."),i=i;li=document.createElement("li"),className="";switch(s.substring(o+1)){case"doc":className="logo-word";break;case"docx":className="logo-word";break;case"ppt":className="logo-ppt";break;case"pdf":className="logo-pdf";break;case"xls":className="logo-excel";break;default:className="logo-ppt"}li.innerHTML='<i class="file-logo '+className+'"></i>'+'<p class="file-header">'+s.substring(0,o)+"</p>"+'<p>上传时间:<span class="upload-time">'+n+"</span>"+"大小:<span>"+r+"</span></p>"+'<i class="logo-error" data-mark='+i+" data-area=self></i>",$(li).attr("data-type",className),this.shopping.append(li),Iscroll.forEach(function(e){setTimeout(function(){e.refresh()},100)})},findIndex:function(t,n){var r=null;refresh();if(t.length===0)return!1;t.forEach(function(e,t){e.mark===n&&(r=t)}),t.splice(r,1),refresh()},deleteItem:function(t){var n=t.parents("li"),r=t.attr("data-mark"),i=t.attr("data-area"),s=null,o=this;i==="self"?this.findIndex(this.filesArray,r):this.findIndex(this.official,r),$.ajax({url:Pathurl.remove,type:"POST",data:{mark:r}}).then(function(e){e.success?(prompt.changeInfo("删除成功!"),error.removeLi(n),console.log(n),o.changeInputText(-1)):prompt.changeInfo("删除失败!")})}};upload.init();