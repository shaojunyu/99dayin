/**
 * Plupload - multi-runtime File Uploader
 * v2.1.8
 *
 * Copyright 2013, Moxiecode Systems AB
 * Released under GPL License.
 *
 * License: http://www.plupload.com/license
 * Contributing: http://www.plupload.com/contributing
 *
 * Date: 2015-07-21
 */

(function(e,t,n){function r(e){function t(e,t,n){var i={chunks:"slice_blob",jpgresize:"send_binary_string",pngresize:"send_binary_string",progress:"report_upload_progress",multi_selection:"select_multiple",dragdrop:"drag_and_drop",drop_element:"drag_and_drop",headers:"send_custom_headers",urlstream_upload:"send_binary_string",canSendBinary:"send_binary",triggerDialog:"summon_file_dialog"};i[e]?r[i[e]]=t:n||(r[e]=t)}var n=e.required_features,r={};if(typeof n=="string")o.each(n.split(/\s*,\s*/),function(e){t(e,!0)});else if(typeof n=="object")o.each(n,function(e,n){t(n,e)});else if(n===!0){e.chunk_size>0&&(r.slice_blob=!0);if(e.resize.enabled||!e.multipart)r.send_binary_string=!0;o.each(e,function(e,n){t(n,!!e,!0)})}return r}var i=e.setTimeout,s={},o={VERSION:"2.1.8",STOPPED:1,STARTED:2,QUEUED:1,UPLOADING:2,FAILED:4,DONE:5,GENERIC_ERROR:-100,HTTP_ERROR:-200,IO_ERROR:-300,SECURITY_ERROR:-400,INIT_ERROR:-500,FILE_SIZE_ERROR:-600,FILE_EXTENSION_ERROR:-601,FILE_DUPLICATE_ERROR:-602,IMAGE_FORMAT_ERROR:-700,MEMORY_ERROR:-701,IMAGE_DIMENSIONS_ERROR:-702,mimeTypes:t.mimes,ua:t.ua,typeOf:t.typeOf,extend:t.extend,guid:t.guid,get:function(e){var n=[],r;t.typeOf(e)!=="array"&&(e=[e]);var i=e.length;while(i--)r=t.get(e[i]),r&&n.push(r);return n.length?n:null},each:t.each,getPos:t.getPos,getSize:t.getSize,xmlEncode:function(e){var t={"<":"lt",">":"gt","&":"amp",'"':"quot","'":"#39"},n=/[<>&\"\']/g;return e?(""+e).replace(n,function(e){return t[e]?"&"+t[e]+";":e}):e},toArray:t.toArray,inArray:t.inArray,addI18n:t.addI18n,translate:t.translate,isEmptyObj:t.isEmptyObj,hasClass:t.hasClass,addClass:t.addClass,removeClass:t.removeClass,getStyle:t.getStyle,addEvent:t.addEvent,removeEvent:t.removeEvent,removeAllEvents:t.removeAllEvents,cleanName:function(e){var t,n;n=[/[\300-\306]/g,"A",/[\340-\346]/g,"a",/\307/g,"C",/\347/g,"c",/[\310-\313]/g,"E",/[\350-\353]/g,"e",/[\314-\317]/g,"I",/[\354-\357]/g,"i",/\321/g,"N",/\361/g,"n",/[\322-\330]/g,"O",/[\362-\370]/g,"o",/[\331-\334]/g,"U",/[\371-\374]/g,"u"];for(t=0;t<n.length;t+=2)e=e.replace(n[t],n[t+1]);return e=e.replace(/\s+/g,"_"),e=e.replace(/[^a-z0-9_\-\.]+/gi,""),e},buildUrl:function(e,t){var n="";return o.each(t,function(e,t){n+=(n?"&":"")+encodeURIComponent(t)+"="+encodeURIComponent(e)}),n&&(e+=(e.indexOf("?")>0?"&":"?")+n),e},formatSize:function(e){function t(e,t){return Math.round(e*Math.pow(10,t))/Math.pow(10,t)}if(e===n||/\D/.test(e))return o.translate("N/A");var r=Math.pow(1024,4);return e>r?t(e/r,1)+" "+o.translate("tb"):e>(r/=1024)?t(e/r,1)+" "+o.translate("gb"):e>(r/=1024)?t(e/r,1)+" "+o.translate("mb"):e>1024?Math.round(e/1024)+" "+o.translate("kb"):e+" "+o.translate("b")},parseSize:t.parseSizeStr,predictRuntime:function(e,n){var r,i;return r=new o.Uploader(e),i=t.Runtime.thatCan(r.getOption().required_features,n||e.runtimes),r.destroy(),i},addFileFilter:function(e,t){s[e]=t}};o.addFileFilter("mime_types",function(e,t,n){e.length&&!e.regexp.test(t.name)?(this.trigger("Error",{code:o.FILE_EXTENSION_ERROR,message:o.translate("File extension error."),file:t}),n(!1)):n(!0)}),o.addFileFilter("max_file_size",function(e,t,n){var r;e=o.parseSize(e),t.size!==r&&e&&t.size>e?(this.trigger("Error",{code:o.FILE_SIZE_ERROR,message:o.translate("File size error."),file:t}),n(!1)):n(!0)}),o.addFileFilter("prevent_duplicates",function(e,t,n){if(e){var r=this.files.length;while(r--)if(t.name===this.files[r].name&&t.size===this.files[r].size){this.trigger("Error",{code:o.FILE_DUPLICATE_ERROR,message:o.translate("Duplicate file error."),file:t}),n(!1);return}}n(!0)}),o.Uploader=function(e){function u(){var e,t=0,n;if(this.state==o.STARTED){for(n=0;n<C.length;n++)!e&&C[n].status==o.QUEUED?(e=C[n],this.trigger("BeforeUpload",e)&&(e.status=o.UPLOADING,this.trigger("UploadFile",e))):t++;t==C.length&&(this.state!==o.STOPPED&&(this.state=o.STOPPED,this.trigger("StateChanged")),this.trigger("UploadComplete",C))}}function a(e){e.percent=e.size>0?Math.ceil(e.loaded/e.size*100):100,f()}function f(){var e,t;M.reset();for(e=0;e<C.length;e++)t=C[e],t.size!==n?(M.size+=t.origSize,M.loaded+=t.loaded*t.origSize/t.size):M.size=n,t.status==o.DONE?M.uploaded++:t.status==o.FAILED?M.failed++:M.queued++;M.size===n?M.percent=C.length>0?Math.ceil(M.uploaded/C.length*100):0:(M.bytesPerSec=Math.ceil(M.loaded/((+(new Date)-O||1)/1e3)),M.percent=M.size>0?Math.ceil(M.loaded/M.size*100):0)}function l(){var e=L[0]||A[0];return e?e.getRuntime().uid:!1}function c(e,n){if(e.ruid){var r=t.Runtime.getInfo(e.ruid);if(r)return r.can(n)}return!1}function h(){this.bind("FilesAdded FilesRemoved",function(e){e.trigger("QueueChanged"),e.refresh()}),this.bind("CancelUpload",w),this.bind("BeforeUpload",m),this.bind("UploadFile",g),this.bind("UploadProgress",y),this.bind("StateChanged",b),this.bind("QueueChanged",f),this.bind("Error",S),this.bind("FileUploaded",E),this.bind("Destroy",x)}function p(e,n){var r=this,i=0,s=[],u={runtime_order:e.runtimes,required_caps:e.required_features,preferred_caps:k,swf_url:e.flash_swf_url,xap_url:e.silverlight_xap_url};o.each(e.runtimes.split(/\s*,\s*/),function(t){e[t]&&(u[t]=e[t])}),e.browse_button&&o.each(e.browse_button,function(n){s.push(function(s){var a=new t.FileInput(o.extend({},u,{accept:e.filters.mime_types,name:e.file_data_name,multiple:e.multi_selection,container:e.container,browse_button:n}));a.onready=function(){var e=t.Runtime.getInfo(this.ruid);t.extend(r.features,{chunks:e.can("slice_blob"),multipart:e.can("send_multipart"),multi_selection:e.can("select_multiple")}),i++,L.push(this),s()},a.onchange=function(){r.addFile(this.files)},a.bind("mouseenter mouseleave mousedown mouseup",function(r){_||(e.browse_button_hover&&("mouseenter"===r.type?t.addClass(n,e.browse_button_hover):"mouseleave"===r.type&&t.removeClass(n,e.browse_button_hover)),e.browse_button_active&&("mousedown"===r.type?t.addClass(n,e.browse_button_active):"mouseup"===r.type&&t.removeClass(n,e.browse_button_active)))}),a.bind("mousedown",function(){r.trigger("Browse")}),a.bind("error runtimeerror",function(){a=null,s()}),a.init()})}),e.drop_element&&o.each(e.drop_element,function(e){s.push(function(n){var s=new t.FileDrop(o.extend({},u,{drop_zone:e}));s.onready=function(){var e=t.Runtime.getInfo(this.ruid);r.features.dragdrop=e.can("drag_and_drop"),i++,A.push(this),n()},s.ondrop=function(){r.addFile(this.files)},s.bind("error runtimeerror",function(){s=null,n()}),s.init()})}),t.inSeries(s,function(){typeof n=="function"&&n(i)})}function d(e,r,i){var s=new t.Image;try{s.onload=function(){if(r.width>this.width&&r.height>this.height&&r.quality===n&&r.preserve_headers&&!r.crop)return this.destroy(),i(e);s.downsize(r.width,r.height,r.crop,r.preserve_headers)},s.onresize=function(){i(this.getAsBlob(e.type,r.quality)),this.destroy()},s.onerror=function(){i(e)},s.load(e)}catch(o){i(e)}}function v(e,n,i){function s(e,t,n){var r=N[e];switch(e){case"max_file_size":e==="max_file_size"&&(N.max_file_size=N.filters.max_file_size=t);break;case"chunk_size":if(t=o.parseSize(t))N[e]=t,N.send_file_name=!0;break;case"multipart":N[e]=t,t||(N.send_file_name=!0);break;case"unique_names":N[e]=t,t&&(N.send_file_name=!0);break;case"filters":o.typeOf(t)==="array"&&(t={mime_types:t}),n?o.extend(N.filters,t):N.filters=t,t.mime_types&&(N.filters.mime_types.regexp=function(e){var t=[];return o.each(e,function(e){o.each(e.extensions.split(/,/),function(e){/^\s*\*\s*$/.test(e)?t.push("\\.*"):t.push("\\."+e.replace(new RegExp("["+"/^$.*+?|()[]{}\\".replace(/./g,"\\$&")+"]","g"),"\\$&"))})}),new RegExp("("+t.join("|")+")$","i")}(N.filters.mime_types));break;case"resize":n?o.extend(N.resize,t,{enabled:!0}):N.resize=t;break;case"prevent_duplicates":N.prevent_duplicates=N.filters.prevent_duplicates=!!t;break;case"browse_button":case"drop_element":t=o.get(t);case"container":case"runtimes":case"multi_selection":case"flash_swf_url":case"silverlight_xap_url":N[e]=t,n||(a=!0);break;default:N[e]=t}n||u.trigger("OptionChanged",e,t,r)}var u=this,a=!1;typeof e=="object"?o.each(e,function(e,t){s(t,e,i)}):s(e,n,i),i?(N.required_features=r(o.extend({},N)),k=r(o.extend({},N,{required_features:!0}))):a&&(u.trigger("Destroy"),p.call(u,N,function(e){e?(u.runtime=t.Runtime.getInfo(l()).type,u.trigger("Init",{runtime:u.runtime}),u.trigger("PostInit")):u.trigger("Error",{code:o.INIT_ERROR,message:o.translate("Init error.")})}))}function m(e,t){if(e.settings.unique_names){var n=t.name.match(/\.([^.]+)$/),r="part";n&&(r=n[1]),t.target_name=t.id+"."+r}}function g(e,n){function r(){f-->0?i(s,1e3):(n.loaded=h,e.trigger("Error",{code:o.HTTP_ERROR,message:o.translate("HTTP Error."),file:n,response:D.responseText,status:D.status,responseHeaders:D.getAllResponseHeaders()}))}function s(){var c,d,v={},m;if(n.status!==o.UPLOADING||e.state===o.STOPPED)return;e.settings.send_file_name&&(v.name=n.target_name||n.name),a&&l.chunks&&p.size>a?(m=Math.min(a,p.size-h),c=p.slice(h,h+m)):(m=p.size,c=p),a&&l.chunks&&(e.settings.send_chunk_number?(v.chunk=Math.ceil(h/a),v.chunks=Math.ceil(p.size/a)):(v.offset=h,v.total=p.size)),D=new t.XMLHttpRequest,D.upload&&(D.upload.onprogress=function(t){n.loaded=Math.min(n.size,h+t.loaded),e.trigger("UploadProgress",n)}),D.onload=function(){if(D.status>=400){r();return}f=e.settings.max_retries,m<p.size?(c.destroy(),h+=m,n.loaded=Math.min(h,p.size),e.trigger("ChunkUploaded",n,{offset:n.loaded,total:p.size,response:D.responseText,status:D.status,responseHeaders:D.getAllResponseHeaders()}),t.Env.browser==="Android Browser"&&e.trigger("UploadProgress",n)):n.loaded=n.size,c=d=null,!h||h>=p.size?(n.size!=n.origSize&&(p.destroy(),p=null),e.trigger("UploadProgress",n),n.status=o.DONE,e.trigger("FileUploaded",n,{response:D.responseText,status:D.status,responseHeaders:D.getAllResponseHeaders()})):i(s,1)},D.onerror=function(){r()},D.onloadend=function(){this.destroy(),D=null},e.settings.multipart&&l.multipart?(D.open("post",u,!0),o.each(e.settings.headers,function(e,t){D.setRequestHeader(t,e)}),d=new t.FormData,o.each(o.extend(v,e.settings.multipart_params),function(e,t){d.append(t,e)}),d.append(e.settings.file_data_name,c),D.send(d,{runtime_order:e.settings.runtimes,required_caps:e.settings.required_features,preferred_caps:k,swf_url:e.settings.flash_swf_url,xap_url:e.settings.silverlight_xap_url})):(u=o.buildUrl(e.settings.url,o.extend(v,e.settings.multipart_params)),D.open("post",u,!0),D.setRequestHeader("Content-Type","application/octet-stream"),o.each(e.settings.headers,function(e,t){D.setRequestHeader(t,e)}),D.send(c,{runtime_order:e.settings.runtimes,required_caps:e.settings.required_features,preferred_caps:k,swf_url:e.settings.flash_swf_url,xap_url:e.settings.silverlight_xap_url}))}var u=e.settings.url,a=e.settings.chunk_size,f=e.settings.max_retries,l=e.features,h=0,p;n.loaded&&(h=n.loaded=a?a*Math.floor(n.loaded/a):0),p=n.getSource(),e.settings.resize.enabled&&c(p,"send_binary_string")&&!!~t.inArray(p.type,["image/jpeg","image/png"])?d.call(this,p,e.settings.resize,function(e){p=e,n.size=e.size,s()}):s()}function y(e,t){a(t)}function b(e){if(e.state==o.STARTED)O=+(new Date);else if(e.state==o.STOPPED)for(var t=e.files.length-1;t>=0;t--)e.files[t].status==o.UPLOADING&&(e.files[t].status=o.QUEUED,f())}function w(){D&&D.abort()}function E(e){f(),i(function(){u.call(e)},1)}function S(e,t){t.code===o.INIT_ERROR?e.destroy():t.code===o.HTTP_ERROR&&(t.file.status=o.FAILED,a(t.file),e.state==o.STARTED&&(e.trigger("CancelUpload"),i(function(){u.call(e)},1)))}function x(e){e.stop(),o.each(C,function(e){e.destroy()}),C=[],L.length&&(o.each(L,function(e){e.destroy()}),L=[]),A.length&&(o.each(A,function(e){e.destroy()}),A=[]),k={},_=!1,O=D=null,M.reset()}var T=o.guid(),N,C=[],k={},L=[],A=[],O,M,_=!1,D;N={runtimes:t.Runtime.order,max_retries:0,chunk_size:0,multipart:!0,multi_selection:!0,file_data_name:"file",flash_swf_url:"js/Moxie.swf",silverlight_xap_url:"js/Moxie.xap",filters:{mime_types:[],prevent_duplicates:!1,max_file_size:0},resize:{enabled:!1,preserve_headers:!0,crop:!1},send_file_name:!0,send_chunk_number:!0},v.call(this,e,null,!0),M=new o.QueueProgress,o.extend(this,{id:T,uid:T,state:o.STOPPED,features:{},runtime:null,files:C,settings:N,total:M,init:function(){var e=this;typeof N.preinit=="function"?N.preinit(e):o.each(N.preinit,function(t,n){e.bind(n,t)}),h.call(this);if(!N.browse_button||!N.url){this.trigger("Error",{code:o.INIT_ERROR,message:o.translate("Init error.")});return}p.call(this,N,function(n){typeof N.init=="function"?N.init(e):o.each(N.init,function(t,n){e.bind(n,t)}),n?(e.runtime=t.Runtime.getInfo(l()).type,e.trigger("Init",{runtime:e.runtime}),e.trigger("PostInit")):e.trigger("Error",{code:o.INIT_ERROR,message:o.translate("Init error.")})})},setOption:function(e,t){v.call(this,e,t,!this.runtime)},getOption:function(e){return e?N[e]:N},refresh:function(){L.length&&o.each(L,function(e){e.trigger("Refresh")}),this.trigger("Refresh")},start:function(){this.state!=o.STARTED&&(this.state=o.STARTED,this.trigger("StateChanged"),u.call(this))},stop:function(){this.state!=o.STOPPED&&(this.state=o.STOPPED,this.trigger("StateChanged"),this.trigger("CancelUpload"))},disableBrowse:function(){_=arguments[0]!==n?arguments[0]:!0,L.length&&o.each(L,function(e){e.disable(_)}),this.trigger("DisableBrowse",_)},getFile:function(e){var t;for(t=C.length-1;t>=0;t--)if(C[t].id===e)return C[t]},addFile:function(e,n){function r(e,n){var r=[];t.each(a.settings.filters,function(t,n){s[n]&&r.push(function(r){s[n].call(a,t,e,function(e){r(!e)})})}),t.inSeries(r,n)}function u(e){var s=t.typeOf(e);if(e instanceof t.File){if(!e.ruid&&!e.isDetached()){if(!h)return!1;e.ruid=h,e.connectRuntime(h)}u(new o.File(e))}else e instanceof t.Blob?(u(e.getSource()),e.destroy()):e instanceof o.File?(n&&(e.name=n),f.push(function(t){r(e,function(n){n||(C.push(e),c.push(e),a.trigger("FileFiltered",e)),i(t,1)})})):t.inArray(s,["file","blob"])!==-1?u(new t.File(null,e)):s==="node"&&t.typeOf(e.files)==="filelist"?t.each(e.files,u):s==="array"&&(n=null,t.each(e,u))}var a=this,f=[],c=[],h;h=l(),u(e),f.length&&t.inSeries(f,function(){c.length&&a.trigger("FilesAdded",c)})},removeFile:function(e){var t=typeof e=="string"?e:e.id;for(var n=C.length-1;n>=0;n--)if(C[n].id===t)return this.splice(n,1)[0]},splice:function(e,t){var r=C.splice(e===n?0:e,t===n?C.length:t),i=!1;return this.state==o.STARTED&&(o.each(r,function(e){if(e.status===o.UPLOADING)return i=!0,!1}),i&&this.stop()),this.trigger("FilesRemoved",r),o.each(r,function(e){e.destroy()}),i&&this.start(),r},dispatchEvent:function(e){var t,n,r;e=e.toLowerCase(),t=this.hasEventListener(e);if(t){t.sort(function(e,t){return t.priority-e.priority}),n=[].slice.call(arguments),n.shift(),n.unshift(this);for(var i=0;i<t.length;i++)if(t[i].fn.apply(t[i].scope,n)===!1)return!1}return!0},bind:function(e,t,n,r){o.Uploader.prototype.bind.call(this,e,t,r,n)},destroy:function(){this.trigger("Destroy"),N=M=null,this.unbindAll()}})},o.Uploader.prototype=t.EventTarget.instance,o.File=function(){function e(e){o.extend(this,{id:o.guid(),name:e.name||e.fileName,type:e.type||"",size:e.size||e.fileSize,origSize:e.size||e.fileSize,loaded:0,percent:0,status:o.QUEUED,lastModifiedDate:e.lastModifiedDate||(new Date).toLocaleString(),getNative:function(){var e=this.getSource().getSource();return t.inArray(t.typeOf(e),["blob","file"])!==-1?e:null},getSource:function(){return n[this.id]?n[this.id]:null},destroy:function(){var e=this.getSource();e&&(e.destroy(),delete n[this.id])}}),n[this.id]=e}var n={};return e}(),o.QueueProgress=function(){var e=this;e.size=0,e.loaded=0,e.uploaded=0,e.failed=0,e.queued=0,e.percent=0,e.bytesPerSec=0,e.reset=function(){e.size=e.loaded=e.uploaded=e.failed=e.queued=e.percent=e.bytesPerSec=0}},e.plupload=o})(window,mOxie);